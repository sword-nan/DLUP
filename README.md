# 说明

本项目的初衷是想利用深度学习的技术实现 astral/tims 质谱数据的分析，实现肽段以及蛋白质的定性定量分析。希望达到以下的目标
-   定性更多低丰度肽段
-   定量范围更广 (range 更大)
-   定量更加准确 (这个主要体现在 QC 样本上)

## 项目中各个文件夹的介绍

-   data_utils
    -   `dataset.py`: 根据质谱数据不同的格式 (后缀名) 定义 dataset 类，如 '.d' 和 '.mzML'
    -    `dataloader.py`: 实现数据读取类，实现训练/测试数据读取、dataset 的转化、train/validation 的划分
-   library
    -   `library_generation.py`: 读取原始 tsv 格式的图谱库、生成 decoy 库、取强度 Top n 的峰、自动补全对齐、
    -   `window_partition.py`: 根据质谱数据的窗口对图谱库进行划分
-   read_raw
    -   `multi_process.py`: 实现多进程操作读取原始质谱数据，<font color='red'>这个地方可能需要优化一下让他适应更多的操作，例如传入函数列表以及参数列表，你后面有时间可以自己优化一下，比如构建一个 `任务调度类`，传入的参数就像下面一样</font>   
        ```python
        parameters:
        -   func_seq: Sequence[Callable]
        -   params_seq: Sequence[Sequence]
        for func, params in zip(func_seq, params_seq):
            future = executor.submit(func, *params)
        ```
    -   `peak_process.py`: 主要实现了峰合并操作，合并小于 ppm 的峰
        -   $|mz_1 - mz_2| < \delta mz_1$
    -   `read_mzml_data.py`: 针对 `mzML` 数据进行读取
    -   `read_tims_data.py`: 针对 `tims` 数据进行读取
-   spectra_match
    -   `matcher.py`: 这个文件是实现谱图匹配的核心文件
        -   图谱匹配这个操作是共有的，因此创建了一个基类，基类里面实现了共有的操作 (匹配、筛选等等)，只不过不同的类型的质谱数据最后提取的原始数据不同，因此实现子类的时候，只需要针对那些原始数据做操作，具体看我基类里面用装饰器定义的抽象函数
        -   无论是在匹配还是筛选时，我们都使用了多进程处理，针对每个文件处理，多进程函数跟上面一样，也是可以优化的，你后面也可以自己实现
        -   基类是不能直接实例化的，每次用的时候只能实例化子类  
        -   你后面如果需要添加一些操作，如果是共有的，则在基类里面更改即可，如若不是则在子类
-   utils
    -   `io.py`: 实现一些文件读取存储功能
    -   `transform.py`: 实现一些转换功能，时间转化为 hour、minute、second
-   model
    -   `model.py`: 定义模型
    -   `model_utils.py`: 实现了训练器类，针对不同的模型直接实例化该类即可

## 实现过程中的一些思考

肽段定性过程中，到底需要哪些特征？
在目前大多数的研究之中，带色谱的数据中可以分为两类
-   利用库中的肽段谱图解 DIA 谱图 (参考 Specter、FIGS)
-   利用子离子共洗脱特性，得到库中肽段的每个子离子的 xic 曲线，计算相关性等等操作 (参考 DIA-NN)

我自己在做的过程中，最初是只利用库中子离子强度、子离子的 xic 曲线 (就是筛选过后的实验图，你把它转置一下，每一行就是对应子离子的 xic 曲线)。

如果需要提升性能，需要额外加入手动计算的特征。

后面发现效果并不是很好(不过可能是模型架构设计的问题)。尝试加入以下的信息，效果略有提升。

-   特异峰向量(可以参考 `window_partition.py` 中的 `search_featured_ions` 函数)
-   xic 曲线相关性
-   峰匹配时的 `ppm` (这个特征可能很重要，因为我发现正库匹配时的 ppm 分布呈正态分布，而反库呈均匀分布)

再后面就尝试能不能直接输入 FIGS 解谱得到的系数，在尝试的过程中发现，如果直接利用上面得到的特异峰向量去解谱，得到的系数可能会是负数。于是后面尝试修改它的定义，如果该峰匹配成功的，并且是特异的，则是特异峰，否则不是。因此对于不同的实验图谱来说，特异峰向量会有所不同，修改后系数正常了。

其实看上面的定义会发现

-   如果 A，B 两个肽段有一个共有的峰，并且其他任何肽段都不共有。那么如果 A 没有匹配上该实验图谱，而 B 匹配上该实验图谱，那么这个峰会由非特异峰转换为特异峰。
-   并不应该实现计算特异峰向量，而是应该针对不同的实验图谱计算。
-   特异峰矩阵的维度应该为 $s \times n$ ($s$ 为筛选后的图谱数量，$n$ 为峰的个数)

后续还考虑了实现对提取的 XIC 做一个平滑处理，再添加 FIGS 生成的系数看看效果怎么样。